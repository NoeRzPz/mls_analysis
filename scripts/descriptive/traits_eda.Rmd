---
title: "Traits exploratory analysis"
author: "Noelia Rodríguez Pérez"
output: word_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Directories setting up

```{r}
workingDir <- getwd()
dataDir <- file.path(workingDir, "data")
resultsDir <- file.path(workingDir,"out") 
```

## Load packages

```{r libraries, message=FALSE}
library(tidyverse)
library(ggpubr)
library(FactoMineR)
library(factoextra)
library(corrplot)
library(GGally)
library(cowplot)
library(ape)
library(phytools)
library(nlme)
library(gt)
library(ggtree)
library(tidytree)
library(treeio)
library(ggimage)
library(ggnewscale)
library(ggrepel)
library(patchwork)
```


## Load data

```{r input data, message=FALSE}
# Import mammals LQ phenotype of sequenced spp
toga_spp <- read_tsv(file.path(dataDir,"LQ_TOGA_species.tsv"), col_names = T)

# Import mammalian all traits (only phenotypic info no sequences info)
mammalian_traits <- read_tsv(file.path(dataDir,"Mammalian_LQ_values.txt"), col_names = T)

# Import families df
spp_family <- read_csv(file.path(dataDir,"spp_family.csv"), col_names = T)

# Load phylogenetic tree 
primates_tree <- read.tree(file.path(dataDir,"science.abn7829_data_s4.nex.tree"))

#anage_primates <- read_tsv(file.path(dataDir,"anage_build15.txt"), col_names = T, 
#                  col_types = list(
#                    "References" = col_character(),   # Needs to be specified or else its interpreted as <int>
#                    "Sample size" = col_factor(c("tiny", "small", "medium", "large", "huge"), ordered = T),
#                    "Data quality" = col_factor(c("low", "questionable", "acceptable", "high"), ordered = T))) %>% 
#  filter(Order == 'Primates',
#    !is.na(`Adult weight (g)`),
#    !is.na(`Maximum longevity (yrs)`))
```

Primates exploratory analysis

```{r formatting data, message=FALSE}
# Select only primates
primates_lq <- toga_spp %>% 
  filter(ORDER == "Primates") %>%
  mutate(label = str_replace(SPECIES, " ", "_"),
         label = str_replace_all(label, "\\s\\w+", "")) %>%
  # Remove duplicated spp
  group_by(SPECIES) %>%
  filter(if (any(!is.na(LQ))) {  # If any non-NA LQ value exists in the group
      !is.na(LQ)           # Keep only the non-NA LQ row
    } else {row_number() == 1    # If all are NA, just keep one of them
    }) %>%
  ungroup() 

# Select only primates
primates_traits <- mammalian_traits  %>%
  filter(Order == "Primates") %>% 
  select(-c("Order tree", "color", "Order", "LQ"))

# Merge both phenotypic dfs to fill missing LQ info (we have 60 spp but 47 with LQ info)
primates_traits <- left_join(primates_lq, primates_traits, by = c("SPECIES" = "Scientific name"))

# check that for all missing LQ in our original database there was no LQ calculated info in mammalian_traits, so we remove that column 
#naLQ_recovered_bymerge <- primates_traits2 %>%
#  filter(is.na(LQ.x)) %>%
#  select(SPECIES,LQ.x,LQ.y)

# Save info obtained
#write.csv(naLQ_recovered_bymerge, file.path(resultsDir,"naLQ_recovered_bymerge.csv"), row.names = FALSE)

# Export spp names with info
write.csv(primates_traits$SPECIES, file.path(resultsDir,"spp_names.csv"), row.names = FALSE)

# Merge both dfs to add family info
primates_traits <- left_join(primates_traits, spp_family[, -1], by = c("SPECIES" = "query"))

# Reorder  df columns
primates_traits <- primates_traits %>%
  select(TOGA_ID, ASSEMBLY,ORDER,Family,label,`Common name`, everything()) %>%
  filter(!is.na(LQ))

# Fill phenotypic data from AnAge
#anage_primates <- anage_primates %>%
#  select(-c("Kingdom", "Phylum", "Class", "Order","Female maturity (days)","Male maturity (days)","Gestation/Incubation (days)","Weaning (days)" , "Litter/Clutch size","Litters/Clutches per year","Inter-litter/Interbirth interval", "Birth weight (g)", "Weaning weight (g)","Growth rate (1/days)", "Source", "Specimen origin", "Sample size", "Data quality", "IMR (per yr)" , "MRDT (yrs)", "Metabolic rate (W)", "Temperature (K)", "References" )) %>%
#  mutate(scientificname = paste(Genus, Species))

# Merge both dfs to add extra pheno info
#primates_traits <- left_join(primates_traits, anage_primates, by = c("SPECIES" = "scientificname"))

# check that for all missing body weight in our original database there was no body weigth calculated info in mammalian_traits, so we remove that column 
#nabodyweigh_recovered_bymerge <- primates_traits2 %>%
#  filter(is.na(`Adult weight (g).x`)) %>%
#  select(SPECIES,`Adult weight (g).x`,`Adult weight (g).y`,`Maximum longevity (yrs).x`,`Maximum longevity (yrs).y`)
#We don't recover extra info so we discart using AnAge

# Save new df with family info
#write.csv(primates_traits, file.path(dataDir,"primates_traits_family.csv"), row.names = FALSE)

# Find the common names between tree labels and trait df
common_names <- intersect(primates_tree$tip.label, primates_traits$label)

# Print alphabetically order different spp, to check for misspell names
sort(setdiff(primates_tree$tip.label, primates_traits$label))
sort(setdiff(primates_traits$label, primates_tree$tip.label))

# Prune tree, keeping the species from our trait dataframe, drop tips that are NOT in common_names
pruned_primates.tree <- drop.tip(primates_tree, setdiff(primates_tree$tip.label, common_names))

# Export tree for using it in caastools
write.tree(pruned_primates.tree, file = file.path(dataDir,"/caas_tool_inputs/primates.tree.nwk"))


# Match the order of pruned_primates.tree$tip.label
primates_traits <- primates_traits %>%
  mutate(ordering = match(label, pruned_primates.tree$tip.label)) %>%
  arrange(ordering) %>%
  filter(!is.na(ordering)) # We keep only spp with representation in the tree

# Export trait dataframe for using it in rerconverge
write.table(primates_traits, file.path(resultsDir,"/descriptive/trait_LQ.tab"), sep = "\t", row.names = FALSE, quote = FALSE)

#Create variable called LQoutlier, where  low outliers are below Q1 − 1.5*IQR and high outliers are above Q3 + 1.5*IQR
Q1 <- quantile(primates_traits$LQ, probs = 0.25, na.rm = T)
Q3 <- quantile(primates_traits$LQ, probs = 0.75, na.rm = T)
IQR <- IQR(primates_traits$LQ, na.rm = T)
global_median <- median(primates_traits$LQ, na.rm = T)

primates_traits <- primates_traits %>% 
  mutate(LQoutlier = case_when(
           LQ < Q1 - (1.5*IQR) ~ "Low_outlier",
           LQ > Q3 + (1.5*IQR) ~ "High_outlier",
           TRUE ~ "No"),
         GD = LQ - global_median,
         # create a column with abreviated name
         short_name = str_replace(label, "^(.).*?_", "\\1.")) %>% 
  # ^(.) captures the first character, .*?_ matches everything (in a non-greedy manner) up to the underscore
  # \\1. replaces with the captured first letter followed by a dot
  group_by(Family) %>%  # Group by Family
  # Calculate each family median and standard deviation
  mutate(MedianFamLQ = median(LQ, na.rm = T),
         sdFamLQ = sd(LQ, na.rm = T),
         # Classify each species in below or above 1 SD 
         spp_class = case_when(
           LQ < (global_median) & LQ < (MedianFamLQ - sdFamLQ) ~ "Below 1 SD",
           LQ > (global_median) & LQ > (MedianFamLQ + sdFamLQ) ~ "Above 1 SD",
           TRUE ~ "Within 1 SD"),
         # Calculate each spp LQ family median differences 
         FD = LQ - MedianFamLQ) %>%
  ungroup()

# Alejandro's column outlier was depicting if spp was on the top50, with LQoutlier only homo sapiens is a high_outlier and was on top50 on alejandro's column

# Export LQ values for using them in caastools
write.table(primates_traits[, c("label","LQ")], file.path(dataDir,"/caas_tool_inputs/LQ.tab"), sep = "\t", row.names = FALSE, quote = FALSE, col.names = FALSE)


```

Prepare a file for caastools with our species:

```{r, eval=FALSE}
my_sp2fam_210727 <- read_delim(file.path(dataDir,"caas_tool_inputs/my_sp2fam.210727.tab"), delim = "\t", escape_double = FALSE, trim_ws = TRUE)
my_sp2fam_210727 <- my_sp2fam_210727 %>%
  filter(Species %in% primates_traits$label)

# Add data from homo sapiens that was missing in the file
new_row <- data.frame(Species = "Homo_sapiens", Family = "APE_Hominidae")

my_sp2fam_210727 <- rbind(my_sp2fam_210727, new_row)

# Export data as a tab separated file for using it in caastools
write.table(my_sp2fam_210727, file.path(dataDir,"/caas_tool_inputs/my_sp2fam_210727.tab"), sep = "\t", row.names = FALSE, quote = FALSE)
```


Trait distribution

```{r}
# Histogram
hist(primates_traits$LQ, xlab = "LQ", main = "Histogram of primates LQ")
dev.copy(png, file.path(resultsDir,"descriptive/LQ_distribution.png"))
dev.off()  # Close the PNG device 
```

Explore all primates traits distributions

```{r}
# Check continuous variables distribution
p <- primates_traits %>% 
  select(`Adult weight (g)`, `Maximum longevity (yrs)`, LQ) %>%
  ggpairs(upper = list(continuous = wrap("cor", method = "spearman")))
# save plot
ggsave(plot = p, filename = file.path(resultsDir,"descriptive/primates_ggpairs.tiff"), dpi = 300, units = "in",width = 6, height = 6)

# Select 2 variables, remove missing variables and calculate spearman correlation from them
cor_numer <- primates_traits %>% 
  select(`Adult weight (g)`, `Maximum longevity (yrs)`, LQ) %>% # select_if(is.numeric) 
  drop_na() %>%
  cor(., method = "spearman") #,use = "pairwise.complete.obs" )

# Specify the tiff device to save plot
tiff(filename = file.path(resultsDir,"descriptive/primates_corplot.tiff"), width = 6, height = 6, units = "in", res = 300)
#  Correlation plot
corrplot.mixed(cor_numer, number.digits = 2, tl.col = "black") # Set the color of text labels for correlation numbers
# variables outside diagonal tl.pos = "lt" 

# Close the device
dev.off()
```
Explore number species in each family

```{r}
# Create a table of primate families, convert it to a data frame for ggplot
family_counts <- data.frame(table(primates_traits$Family)) %>%
  # Order it by abundance
  arrange(desc(Freq))

# save max freq
max_freq <- max(family_counts$Freq)

# Create the ggplot barplot
ggplot(family_counts, aes(x = reorder(Var1, Freq), y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  coord_flip() +  # Makes the bars horizontal
  scale_y_continuous(breaks = seq(0, max_freq, by = 1)) +  # Set y-axis breaks
  labs(title = "Primate Families by Abundance", x = "Family", y = "Count") +
  theme_classic() +
  theme(legend.position = "none")

# Save the plot to a file
ggsave(file.path(resultsDir,"descriptive/primate_families_barplot.png"), width = 10, height = 8, dpi = 300)
```

Plot phylogeny

```{r}
ape::plot.phylo(pruned_primates.tree)
ape::axisPhylo()  
mtext("Million Years before present", side = 1, line = 3)
```
We observe the distribution of the internal nodes

```{r}
ggtree(pruned_primates.tree) + geom_tiplab() + 
  hexpand(0.2) + geom_text(aes(label = ifelse(isTip, NA, node)), hjust = -0.25)  #To get the internal node number
```

Add trait info to the tree

```{r}
# convert the phylo object to a tidy data frame, a tbl_tree object
pruned_primates.tree2 <- as_tibble(pruned_primates.tree)

# mapping external data to the tree structure
pruned_primates.tree2 <- full_join(pruned_primates.tree2, primates_traits, by = 'label') 

# Determine the MRCA node for each family
mrcas <- c()
mrca <- MRCA(pruned_primates.tree, 9,23)
mrcas <- c(mrcas, mrca) 
mrca <- MRCA(pruned_primates.tree, 26,27)
mrcas <- c(mrcas, mrca) 
mrca <- MRCA(pruned_primates.tree, 4,1)
mrcas <- c(mrcas, mrca) 
mrca <- MRCA(pruned_primates.tree, 6,5)
mrcas <- c(mrcas, mrca) 
mrca <- MRCA(pruned_primates.tree, 28)
mrcas <- c(mrcas, mrca) 
mrca <- MRCA(pruned_primates.tree, 32,33)
mrcas <- c(mrcas, mrca) 
mrca <- MRCA(pruned_primates.tree, 36,35)
mrcas <- c(mrcas, mrca) 
mrca <- 29
mrcas <- c(mrcas, mrca) 
mrca <- 38
mrcas <- c(mrcas, mrca) 
mrca <- 37
mrcas <- c(mrcas, mrca) 
#write(mrcas, file = file.path(dataDir, "/mrcas.txt"))


# Define node family labels
nodes <- c(48, 64, 43, 46, 28, 70, 74, 29, 38, 37)
names(nodes) <- c("Cercopithecidae", "Hominidae","Cebidae","Atelidae","Tarsiidae","Lemuridae","Cheirogaleidae","Daubentoniidae","Galagidae","Lorisidae")

# Vector with the families ordered in the way they appear on the plylogenetic tree
treeFam_ordered <- names(nodes)

# Assing all nodes from that clade their corresponding family
pruned_primates.tree2 <- groupClade(pruned_primates.tree2, nodes)

# the tbl_tree object is converted to a treedata object
pruned_primates.tree2 <- tidytree::as.treedata(pruned_primates.tree2)

# Group clade assing 0 tho the rest of the nodes and we want that appear as NA
pruned_primates.tree2@data$group[pruned_primates.tree2@data$group == 0] <- NA
```

Depict trait values on phylogeny

```{r Global median differences}
# Exclude outlier from trait representation
primates_traits2 <- primates_traits
primates_traits2$GD <- ifelse(primates_traits2$LQoutlier == "High_outlier", NA, primates_traits2$GD)

primates_lq_tree2 <- primates_traits2 %>% 
  column_to_rownames(var = "label") %>% 
  select(GD)

circ <- ggtree(pruned_primates.tree2, layout = "circular") +
  geom_tree(aes(color = group), size = 1.5) +  # Color branches/edges
  labs(color = "Family")  # set the legend title
  
p3 <- gheatmap(circ, primates_lq_tree2, offset = .8, width = .2, colnames_angle = 95, colnames_offset_y = .05) + 
  scale_fill_gradient2(name = "GD value", limits = c(-1,1), na.value = "grey50")

p3
# save plot
ggsave(plot = p3, filename = file.path(resultsDir,"descriptive/ggtree_global_median_diff.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

```{r Family median differences}
# Exclude outlier from trait representation
primates_traits2 <- primates_traits
primates_traits2$FD <- ifelse(primates_traits2$LQoutlier == "High_outlier", NA, primates_traits2$FD)

primates_lq_tree2 <- primates_traits2 %>% 
  column_to_rownames(var = "label") %>% 
  select(FD)

circ <- ggtree(pruned_primates.tree2, layout = "circular") +
  geom_tree(aes(color = group), size = 1.5) +  # Color branches/edges
  labs(color = "Family")  # set the legend title

p4 <- gheatmap(circ, primates_lq_tree2, offset = .8, width = .2, colnames_angle = 95, colnames_offset_y = .05) + 
  scale_fill_gradient2(name = "FD value", limits = c(-1.05,1),  na.value = "grey50")

p4
# save plot
ggsave(plot = p4, filename = file.path(resultsDir,"descriptive/ggtree_fam_median_diff.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```


```{r both median differences}
# Exclude outlier from trait representation
primates_traits2 <- primates_traits
primates_traits2$GD <- ifelse(primates_traits2$LQoutlier == "High_outlier", NA, primates_traits2$GD)
primates_traits2$FD <- ifelse(primates_traits2$LQoutlier == "High_outlier", NA, primates_traits2$FD)

primates_lq_tree2 <- primates_traits2 %>% 
  column_to_rownames(var = "label") %>% 
  select(GD,FD)

circ <- ggtree(pruned_primates.tree2, layout = "circular") +
  geom_tree(aes(color = group), size = 1.5) +  # Color branches/edges
  labs(color = "Family")  # set the legend title

p5 <- gheatmap(circ, primates_lq_tree2, offset = .8, width = .2, colnames_angle = 95, colnames_offset_y = .05) + 
  scale_fill_gradient2(name = "Median difference", limits = c(-1.05,1),  na.value = "grey50")

p5
# save plot
ggsave(plot = p5, filename = file.path(resultsDir,"descriptive/ggtree_both_median_diff.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```



```{r LQ family distribution 1SD}
# Calculate global median and standard deviation

primates1SD <- primates_traits %>% 
  group_by(Family) %>%
  ggplot(aes(x = Family, y = LQ, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class), size = 3) +
  scale_x_discrete(limits = rev(treeFam_ordered)) + # Set the order here
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Below 1 SD" = 22, "Within 1 SD" = 21,"Above 1 SD" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Dray global median
  geom_hline(yintercept = median(primates_traits$LQ, na.rm = T), linetype = "dashed", color = "grey", linewidth = 1) +
  coord_flip() +
  labs(x = 'Family',
    y = 'Longevity Quotient') +
  theme_classic() + 
  labs_pubr() +
  theme(
    legend.position = "none",
    text = element_text(size = 18))

primates1SD
# save plot
ggsave(plot = primates1SD, filename = file.path(resultsDir,"descriptive/1SDextreme_byfamily.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

```{r LQ family distribution 1.5SD}
# Con 3SD ni con 2SD no sale nada

primatesSDs <- primates_traits %>% 
  group_by(Family) %>%
  mutate(spp_class = case_when(
           LQ < (global_median) & LQ < (MedianFamLQ - (1.5*sdFamLQ)) ~ "Bottom species",
           LQ > (global_median) & LQ > (MedianFamLQ + (1.5*sdFamLQ)) ~ "Top species",
           TRUE ~ "Not extreme")) %>%
  ggplot(aes(x = Family, y = LQ, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class), size = 3) +
  scale_x_discrete(limits = rev(treeFam_ordered)) + # Set the order here
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Bottom species" = 22, "Not extreme" = 21,"Top species" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Dray global median
  geom_hline(yintercept = median(primates_traits$LQ, na.rm = T), linetype = "dashed", color = "grey", linewidth = 1) +
  coord_flip() +
  labs(x = 'Family',
    y = 'Longevity Quotient') +
  theme_classic() + 
  labs_pubr() +
  theme(
    legend.position = "none",
    text = element_text(size = 18))

primatesSDs
# save plot
ggsave(plot = primates1SD, filename = file.path(resultsDir,"descriptive/1.5SDextreme_byfamily.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

Getting the spp names with extreme top values and extreme bottom values
```{r}
# Getting names for 1SD
top1SD_spp <- primates_traits %>%
  filter(spp_class == "Above 1 SD") %>%
  select(Family,SPECIES, LQ)

bottom1SD_spp <- primates_traits %>%
  filter(spp_class == "Below 1 SD") %>%
  select(Family,SPECIES, LQ)

top1SD_spp
bottom1SD_spp
```
Getting names for 1.5 SD

```{r}
top <- primatesSDs[["data"]]  %>%
  ungroup()  %>%
  filter(spp_class == "Top species") %>%
  select(Family,SPECIES)
bottom <- primatesSDs[["data"]]   %>%
  ungroup()  %>%
  filter(spp_class == "Bottom species") %>%
  select(Family,SPECIES)
top
bottom
```

We try with another strategy, using quantiles

```{r family quantiles}
primates_q <- primates_traits %>% 
  group_by(Family) %>%
  mutate(spp_class = case_when(
           LQ < (global_median) & LQ < quantile(LQ, 0.25, na.rm=TRUE) ~ "Bottom species",
           LQ > (global_median) & LQ > quantile(LQ, 0.75, na.rm=TRUE) ~ "Top species",
           TRUE ~ "Not extreme")) %>%
  ggplot(aes(x = Family, y = LQ, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class), size = 3) +
  scale_x_discrete(limits = rev(treeFam_ordered)) + # Set the order here
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Bottom species" = 22, "Not extreme" = 21,"Top species" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Dray global median
  geom_hline(yintercept = median(primates_traits$LQ, na.rm = T), linetype = "dashed", color = "grey", linewidth = 1) +
  coord_flip() +
  labs(x = 'Family',
    y = 'Longevity Quotient') +
  theme_classic() + 
  labs_pubr() +
  theme(
    legend.position = "none",
    text = element_text(size = 18))

primates_q

# save plot
ggsave(plot = primates_q, filename = file.path(resultsDir,"descriptive/primates_quantiles_famdistribution.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

```{r global quantiles}
primates_gq <- primates_traits %>% 
  group_by(Family) %>%
  mutate(spp_class = case_when(
           LQ < (global_median) & LQ < Q1 ~ "Bottom species",
           LQ > (global_median) & LQ > Q3 ~ "Top species",
           TRUE ~ "Not extreme")) %>%
  ggplot(aes(x = Family, y = LQ, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class), size = 3) +
  scale_x_discrete(limits = rev(treeFam_ordered)) + # Set the order here
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Bottom species" = 22, "Not extreme" = 21,"Top species" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Dray global median
  geom_hline(yintercept = median(primates_traits$LQ, na.rm = T), linetype = "dashed", color = "grey", linewidth = 1) +
  coord_flip() +
  labs(x = 'Family',
    y = 'Longevity Quotient') +
  theme_classic() + 
  labs_pubr() +
  theme(
    legend.position = "none",
    text = element_text(size = 18))

primates_gq

# save plot
ggsave(plot = primates_gq, filename = file.path(resultsDir,"descriptive/primates_globalquantiles_distribution.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

Getting the spp names with extreme top values and extreme bottom values

```{r}
intermediate <- primates_q[["data"]]  %>%
    ungroup()  %>%
    filter(spp_class == "Not extreme") %>% 
    select(label)
# Export intermediate LQ spp for internal validation
write.table(intermediate, file.path(resultsDir,"/functional/intermediate_spp.tab"), sep = "\t", row.names = FALSE, quote = FALSE, col.names = FALSE)

top <- primates_q[["data"]]  %>%
  ungroup()  %>%
  filter(spp_class == "Top species") %>% 
  select(Family, label, LQ)

bottom <- primates_q[["data"]]   %>%
  ungroup()  %>%
  filter(spp_class == "Bottom species") %>% 
  select(Family,label, LQ) 
top
bottom
```
We keep only families with top and bottoms and also we keep 1 spp from Cercopithecidae family

```{r}
# Identifying common families
common_families <- intersect(top$Family, bottom$Family)

# Filtering rows from top and bottom species based on common families
top <- top %>% filter(Family %in% common_families) %>%
  filter(LQ > 1.88) %>% # By filtering by LQ value, we select only one species from Cercopithecidae
  # Add this variable to codify them as caastools requirements
  mutate(code = rep(1,nrow(.)))

bottom <- bottom %>% filter(Family %in% common_families) %>%
  # We only filter by values < an LQ threshold when the family is Cercopithecidae, to keep one species from them
  filter(if_else(Family == "Cercopithecidae", LQ < 1.07, TRUE)) %>%
  mutate(code = rep(0,nrow(.)))

# Binding the rows together
extreme_LQ <- rbind(top, bottom) 

extreme_LQ <- extreme_LQ %>%
  select(label,code)

write.table(extreme_LQ, file.path(dataDir,"/caas_tool_inputs/LQ_config.txt"), sep = "\t", row.names = FALSE, quote = FALSE, col.names = FALSE)
```


Make scatter plot of LQ vs weight in between in primates database for part A of figure 1

```{r LQ vs BMass scatter}
# Plot the same way as before
scatterLQ <- primates_traits %>% 
  ggplot(aes(x = `Adult weight (g)`, y = LQ, color = Family)) +
  geom_point(size = 2) +
  scale_x_log10() +
  scale_y_log10() +
  geom_smooth(
    method = 'lm', 
    aes(`Adult weight (g)`, LQ), 
    inherit.aes = FALSE,
    col = "black") +
  labs( x = 'Log10(Adult Weight)',
    y = 'Log10(LQ)') +
  theme_classic() + 
  labs_pubr() +
  theme(
    legend.position = "right",
    text = element_text(size = 16))

scatterLQ

scatterLQkg <- primates_traits %>% 
  mutate(body_masskg = `Adult weight (g)`/1000) %>% 
  ggplot(aes(x = body_masskg, y = LQ, color = Family)) +
  geom_point(size = 2) +
  scale_x_log10() +
  scale_y_log10() +
  geom_smooth(
    method = 'lm', 
    aes(body_masskg, LQ), 
    inherit.aes = FALSE,
    col = "black") +
  labs( x = 'Log10(Adult Weight (kg))',
    y = 'Log10( LQ)') +
  theme_classic() + 
  labs_pubr() +
  theme(
    legend.position = "none",
    text = element_text(size = 14))

scatterLQkg
# save plot
ggsave(plot = scatterLQkg, filename = file.path(resultsDir,"descriptive/logscatterLQkg.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

Make scatter plot of weight vs MLS in between primates in our database

```{r MLS vs BMass scatter}
# Plot
scatter_g <- primates_traits %>% 
  ggplot(aes(x = `Adult weight (g)`, y = `Maximum longevity (yrs)`, color = Family)) +
  geom_point(size = 2) +
  scale_x_log10() +
  scale_y_log10() +
  geom_smooth(
    method = 'lm', 
    aes(`Adult weight (g)`, `Maximum longevity (yrs)`), 
    inherit.aes = FALSE,
    col = "black") +
  labs(x = 'Log10(Adult Weight)',
    y = 'Log10(Maximum Longevity)') +
  theme_classic() + 
  labs_pubr() +
  theme(
    legend.position = "right",
    text = element_text(size = 16))
scatter_g 

scattermlskg <- primates_traits %>% 
  mutate(body_masskg = `Adult weight (g)`/1000) %>% 
  ggplot(aes(x = body_masskg, y = `Maximum longevity (yrs)`, color = Family)) +
  geom_point(size = 2) +
  scale_x_log10() +
  scale_y_log10() +
  geom_smooth(
    method = 'lm', 
    aes(body_masskg, `Maximum longevity (yrs)`), 
    inherit.aes = FALSE,
    col = "black") +
  labs( x = 'Log10(Adult Weight (kg))',
    y = 'Log10(Maximum Lifespan (yrs))') +
  theme_classic() + 
  labs_pubr() +
  theme(
    legend.position = "right",
    text = element_text(size = 16))

scattermlskg

# save plot
ggsave(plot = scatter_g, filename = file.path(resultsDir,"descriptive/scatter_mlsg.tiff"), dpi = 300, units = "in",width = 6, height = 6)
ggsave(plot = scattermlskg, filename = file.path(resultsDir,"descriptive/scatter_mlskg.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

Building part B of figure 1

Collapse tree at internal nodes corresponding with its family label

```{r collapse tree by family}
# This collapse tree by family
p <- ggtree(pruned_primates.tree2, aes(color = group)) + theme(legend.position = 'none')
famtree <- p %>% 
  ggtree::collapse(node = 48) %>%
  ggtree::collapse(node = 64) %>%
  ggtree::collapse(node = 43) %>%
  ggtree::collapse(node = 46) %>%
  ggtree::collapse(node = 70) %>%
  ggtree::collapse(node = 74) 

# Store the tree 
famtree <- famtree + geom_nodelab(aes(subset = !is.na(group)), align = TRUE, linetype = "solid") + theme(plot.margin = unit(c(0, 0, 1, 0), "cm")) #+ coord_fixed(ratio = 18)
```

```{r LQ figure 1 B}
selected_names <- primates_traits %>%
  filter(label %in% extreme_LQ$label) %>%
  select(short_name)

# Order of Family apearance in the tree
# Set the family column as an ordered factor based on the specified order
#primates_traits$Family <- factor(primates_traits$Family, levels= rev(treeFam_ordered))

primates_q <- primates_traits %>% 
  group_by(Family) %>%
  mutate(spp_class = case_when(
           LQ < (global_median) & LQ < quantile(LQ, 0.25, na.rm=TRUE) ~ "Bottom",
           LQ > (global_median) & LQ > quantile(LQ, 0.75, na.rm=TRUE) ~ "Top",
           TRUE ~ "Not extreme")) %>%
  ggplot(aes(x = Family, y = LQ, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class), size = 3) +
  scale_x_discrete(limits = rev(treeFam_ordered)) + # Set the order here
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Bottom" = 22, "Not extreme" = 21,"Top" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Draw global median
  geom_hline(yintercept = median(primates_traits$LQ, na.rm = T), linetype = "dashed", color = "grey", linewidth = 1) +
  # Add repelled text labels for top and bottom species,
  #  max.overlaps = Inf
  geom_text_repel(aes(label = ifelse(short_name %in% selected_names$short_name, short_name, "")),
    size = 3,
    color = "black",
    box.padding = 0.15,
    point.padding = 0.15) +
  coord_flip() +
  labs(y = 'Longevity Quotient', shape = "") +
  theme_classic() + 
  labs_pubr() +
  theme(axis.title.y = element_blank(), 
        axis.title.x = element_text(size = 12), 
        legend.position = "right",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        text = element_text(size = 12)) +
  guides(color = "none", fill = "none") + # remove family legend for color and fill
  labs(shape = "Extreme species") # Set the legend title here

# Combining the plots
tree_LQdistribution <- plot_grid(famtree, primates_q, rel_widths = c(0.2, 0.8))#ncol=2,
tree_LQdistribution

# save plot
ggsave(plot = tree_LQdistribution, filename = file.path(resultsDir,"descriptive/fig1_B.tiff"), dpi = 300)
```

Build part C of figure 1

```{r}
extreme_spp <- primates_traits %>%
  filter(label %in% extreme_LQ$label) %>%
  select(label,SPECIES, LQ) %>%
  arrange(LQ)

# keep a tree with only the extreme_spp
# Find the common names between tree labels and trait df
common_names <- intersect(primates_tree$tip.label, extreme_spp$label)

# Prune tree, keeping the species from our trait dataframe, drop tips that are NOT in common_names
extreme_primates.tree <- drop.tip(primates_tree, setdiff(primates_tree$tip.label, common_names))

# search the images uid
# Sapajus_apella: 76ac06f6-d6ef-493d-bab2-216c3c7cda6a
# Alouatta_palliata c97add16-c237-4f6f-be78-4e0addfc5720
# Define function to catch more number uids
safe_phylopic_uid <- function(species_name) {
  
  uid <- tryCatch({
    ggimage::phylopic_uid(species_name)
  }, error = function(e) {
    return(NULL) 
  })
  
  # If UID not found for species, try genus
  if (is.null(uid)) {
    genus <- unlist(strsplit(species_name, "_"))[1] # Extract genus from species name
    uid <- tryCatch({
      ggimage::phylopic_uid(genus)
    }, error = function(e) {
      return(NULL) # return NULL on error
    })
    # to avoid that in the name of the uid apears only the genus
    if (!is.null(uid)) {
      uid$name <- species_name
      row.names(uid) <- species_name
    }
  }
  return(uid)
}

# apply the function
uids <- sapply(extreme_primates.tree$tip.label, safe_phylopic_uid)

# Remove NULL entries (those without images)
d <-  data.frame()
valid_uids <- Filter(Negate(is.null), uids)
for (i in names(valid_uids)) {
  d <- rbind(d,valid_uids[[i]])
}
# Export table
write.table(d, file.path(resultsDir,"descriptive/uids.tab"), sep = "\t", row.names = TRUE, quote = FALSE)

#d <- ggimage::phylopic_uid(extreme_names)
# I have to add the full name to the ones I searched for genus

# Update your plot with the filtered data
p <- ggtree(extreme_primates.tree, layout = "slanted") %<+% d + 
  geom_tiplab(aes(image = uid), geom = "phylopic", offset = 2) #+ xlim(NA, 7)

# Print the plot
p
```

Table displaying selected top and bottom species

```{r}
top_data <- primates_q[["data"]] %>%
  ungroup() %>%
  filter(spp_class == "Top" & label %in% extreme_LQ$label) %>%
  select(SPECIES, LQ)  %>%
  arrange(LQ)

bottom_data <- primates_q[["data"]] %>%
  ungroup() %>%
  filter(spp_class == "Bottom" & label %in% extreme_LQ$label) %>%
  select(SPECIES, LQ)  %>%
  arrange(LQ)

# Bind them side by side
combined_data <- bind_cols(bottom_data, top_data)
# Rename columns for clearer identification
colnames(combined_data) <- c("Bottom_Species_Name", "Bottom_LQ_Value", "Top_Species_Name", "Top_LQ_Value")

# Create the gt table
tab_fig1c <- combined_data %>%
  mutate(
    Bottom_LQ_Value = round(Bottom_LQ_Value, 2),
    Top_LQ_Value = round(Top_LQ_Value, 2)) %>%
  gt() %>%
  cols_label(
    Bottom_Species_Name = "Species",
    Bottom_LQ_Value = "LQ",
    Top_Species_Name = "Species",
    Top_LQ_Value = "LQ") %>%
  tab_spanner( 
    label = "Bottom",
    columns = c("Bottom_Species_Name", "Bottom_LQ_Value")) %>%
  tab_spanner(
    label = "Top",
    columns = c("Top_Species_Name", "Top_LQ_Value"))

# Display table
tab_fig1c

# Save the gt table as a Word document (experimental in `gt`)
gt::gtsave(tab_fig1c, filename = file.path(resultsDir, "descriptive/topbottom_spp_table.docx"))
```


When all figures are built, we will use this code

```{r tfm figure 1, eval=FALSE}
(scatterLQkg|tree_LQdistribution)+ 
  plot_layout(widths = c(1, 2.5))#,  ncol = 2, tag_levels= c("A","B"), rel_widths = c(0.3, 0.7)) 

library(magick)
# Import TIFF image
image1 <- image_read(file.path(resultsDir,"descriptive/fig1c.tif"))
# Convert TIFF images to ggplot objects:
figC <- ggdraw() + draw_image(image1)

combined_plot <- plot_grid(figAB, figC,  nrow = 2) 
combined_plot
final_plot <- combined_plot  + 
  plot_annotation(tag_levels= c("A","B", "C"))
# save plots
ggsave(plot = combined_plot, filename = file.path(resultsDir,paste0("descriptive/figure_1.tiff")), dpi = 300)
```

Table to summarized traits of interest

```{r table}
# Clean and Summarize the Data
summary_data <- primates_traits %>%
  group_by(Family) %>%
  # Summarize data
  summarize(
    n = n(),
    MLS_Mean = mean(`Maximum longevity (yrs)`, na.rm = TRUE),
    MLS_SD = sd(`Maximum longevity (yrs)`, na.rm = TRUE),
    min_MLS = min(`Maximum longevity (yrs)`, na.rm = TRUE),
    max_MLS = max(`Maximum longevity (yrs)`, na.rm = TRUE),
    LQ_Mean = mean(LQ, na.rm = TRUE),
    LQ_SD = sd(LQ, na.rm = TRUE),
    min_LQ = round(min(LQ, na.rm = TRUE),1),
    max_LQ = round(max(LQ, na.rm = TRUE),1))  %>% 
  # Compute the MLS Limits
  mutate(MLS_Limits = paste(min_MLS, "-", max_MLS),
         LQ_Limits = paste(min_LQ, "-",max_LQ))
summary_data

# Use the gt function to create the table
table_display <- summary_data %>%
  select(Family,n,MLS_Mean,MLS_SD, MLS_Limits, LQ_Mean, LQ_SD, LQ_Limits) %>%
  gt() %>%
  tab_header(title = "Table. Mean MLS and LQ Computed Using All Records from our Primate Database") %>%
  
  # Formatting columns for better display
  fmt_number(columns = c("MLS_Mean", "MLS_SD", "LQ_Mean", "LQ_SD"), decimals = 2) %>%
  
  # Adding and removing table lines
  tab_options(
    table.border.top.style = "none",  # Remove the top border
    table.border.bottom.style = "solid",
    table.border.bottom.width = 2,
    column_labels.border.top.style = "double",
    column_labels.border.bottom.style = "double")

# Display the table
table_display

# Save the gt table as a Word document (experimental in `gt`)
gt::gtsave(table_display, filename = file.path(resultsDir, "descriptive/primates_table.docx"))
```

PGLS
I add some code to test it when I have the data

```{r PGLS}
# There are 2 missing values 
primates_traits <- primates_traits %>%
  rename(MaxLongevity = `Maximum longevity (yrs)`, AdultWeight = `Adult weight (g)`) %>%
  filter(!is.na(MaxLongevity),!is.na(AdultWeight))

# Find the common names between tree labels and trait df
common_names <- intersect(primates_tree$tip.label, primates_traits$label)
# Prune tree, keeping the species from our trait dataframe
pruned_primates.tree <- drop.tip(primates_tree, setdiff(primates_tree$tip.label, common_names))

bm.mam <- corBrownian(phy = pruned_primates.tree)

# Fit the PGLS model (comprobar codigo en capitulo q nos pasaron)
pgls_model <- gls(MaxLongevity ~ AdultWeight, data = primates_traits, correlation = bm.mam)

# View the results
plot(pgls_model)
summary(pgls_model)

# Get residuals from the PGLS model
pgls_residuals <- residuals(pgls_model)
#no parece que los residuos coincidan con los que tenia alejandro, aunque los de él fueron calculados para mamímeros, no solo para primates
primates_traits$pgls_residuals <- pgls_residuals
```

Maximum lifespan distribution in every primate family:
I create plots as in Alejandro's paper for primates to compare with his results once I have the data to perform the PGLS an use the residuals of the MLS regressed over body mass
Ask what the global criteria should be, if the species have to be only above the global median to be considered extreme long lived plus each family criteria or they need to be above global median plus above 1SD of the global median

```{r residuals family distributions}
# Calculate global median and standard deviation
global_median <- median(primates_traits$pgls_residuals)
global_sd <- sd(primates_traits$pgls_residuals) 

primates <- primates_traits %>% 
  group_by(Family) %>%  # Group by Family
  # Calculate each family median and standar deviation
  mutate(MedianFamLongevity = median(pgls_residuals),
         sdFamLongevity = sd(pgls_residuals),
         # Classify each species in below or above 1 SD 
         spp_class = case_when(
           pgls_residuals < (global_median) & pgls_residuals < (MedianFamLongevity - sdFamLongevity) ~ "Below 1 SD",
           pgls_residuals > (global_median) & pgls_residuals > (MedianFamLongevity + sdFamLongevity) ~ "Above 1 SD",
           TRUE ~ "Within 1 SD")) %>% 
  ggplot(aes(x = reorder(Family, ordering), y = pgls_residuals, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class),  size = 3) +
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Below 1 SD" = 22, "Within 1 SD" = 21,"Above 1 SD" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Dray global median
  geom_hline(yintercept = median(primates_traits$pgls_residuals), linetype = "dashed", color = "grey", linewidth = 1) +
  coord_flip() +
  labs(x = 'Family',
    y = 'Maximum Lifespan residuals') +
  theme_classic() + 
  labs_pubr() +
  theme(legend.position = "none",
        text = element_text(size = 16))

primates
# save plot
ggsave(plot = primates, filename = file.path(resultsDir,"descriptive/SD_resprimates_famdistributionr.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

```{r alejandro resi fam distributions}
# Calculate global median and standard deviation
global_median <- median(primates_traits$residuals)
global_sd <- sd(primates_traits$residuals) 

primates <- primates_traits %>% 
  group_by(Family) %>%  # Group by Family
  # Calculate each family median and standar deviation
  mutate(MedianFamLongevity = median(residuals),
         sdFamLongevity = sd(residuals),
         # Classify each species in below or above 1 SD 
         spp_class = case_when(
           residuals < (global_median) & residuals < (MedianFamLongevity - sdFamLongevity) ~ "Below 1 SD",
           residuals > (global_median) & residuals > (MedianFamLongevity + sdFamLongevity) ~ "Above 1 SD",
           TRUE ~ "Within 1 SD")) %>% 
  ggplot(aes(x = reorder(Family, ordering), y = residuals, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class),  size = 3) +
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Below 1 SD" = 22, "Within 1 SD" = 21,"Above 1 SD" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Dray global median
  geom_hline(yintercept = median(primates_traits$residuals), linetype = "dashed", color = "grey", linewidth = 1) +
  coord_flip() +
  labs(x = 'Family',
    y = 'Maximum Lifespan residuals') +
  theme_classic() + 
  labs_pubr() +
  theme(legend.position = "none",
        text = element_text(size = 16))

primates
# save plot
ggsave(plot = primates, filename = file.path(resultsDir,"descriptive/primates_Alejandrofamdistributionr.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```
Same plots using quantiles criteria

```{r residuals quantiles family distributions}
# Calculate global median and standard deviation
global_median <- median(primates_traits$pgls_residuals)

res_primates <- primates_traits %>% 
  group_by(Family) %>%  # Group by Family
  # Calculate each family median and standar deviation
  mutate(MedianFamLongevity = median(pgls_residuals),
         # Classify each species in below or above 1 SD 
         spp_class = case_when(
           pgls_residuals < (global_median) & pgls_residuals < quantile(pgls_residuals, 0.25, na.rm=TRUE) ~ "Bottom species",
           pgls_residuals > (global_median) & pgls_residuals > quantile(pgls_residuals, 0.75, na.rm=TRUE) ~ "Top species",
           TRUE ~ "Not extreme")) %>% 
  ggplot(aes(x = reorder(Family, ordering), y = pgls_residuals, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class),  size = 3) +
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Bottom species" = 22, "Not extreme" = 21,"Top species" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Dray global median
  geom_hline(yintercept = median(primates_traits$pgls_residuals), linetype = "dashed", color = "grey", linewidth = 1) +
  coord_flip() +
  labs(x = 'Family',
    y = 'Maximum Lifespan residuals') +
  theme_classic() + 
  labs_pubr() +
  theme(legend.position = "none",
        text = element_text(size = 16))

res_primates
# save plot
ggsave(plot = res_primates, filename = file.path(resultsDir,"descriptive/residuals_quantiles_famdistributionr.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```
Alejandro's residuals

```{r residuals quantiles family distributions}
# Calculate global median and standard deviation
global_median <- median(primates_traits$residuals)

ares_primates <- primates_traits %>% 
  group_by(Family) %>%  # Group by Family
  # Calculate each family median and standar deviation
  mutate(MedianFamLongevity = median(residuals),
         # Classify each species in below or above 1 SD 
         spp_class = case_when(
           residuals < (global_median) & residuals < quantile(residuals, 0.25, na.rm=TRUE) ~ "Bottom species",
           residuals > (global_median) & residuals > quantile(residuals, 0.75, na.rm=TRUE) ~ "Top species",
           TRUE ~ "Not extreme")) %>% 
  ggplot(aes(x = reorder(Family, ordering), y = residuals, color = Family, fill = Family)) +
  geom_jitter(aes(shape = spp_class),  size = 3) +
  # Represent each species with different shapes according the species clas they belong respect to their MLS
  scale_shape_manual(values = c("Bottom species" = 22, "Not extreme" = 21,"Top species" = 24)) +
  # Draw family median
  stat_summary(fun.y = median, geom = "errorbar",
               aes(ymax = ..y.., ymin = ..y..), linewidth = 1) +
  # Dray global median
  geom_hline(yintercept = median(primates_traits$residuals), linetype = "dashed", color = "grey", linewidth = 1) +
  coord_flip() +
  labs(x = 'Family',
    y = 'Maximum Lifespan residuals') +
  theme_classic() + 
  labs_pubr() +
  theme(legend.position = "none",
        text = element_text(size = 16))

ares_primates
# save plot
ggsave(plot = ares_primates, filename = file.path(resultsDir,"descriptive/alejandro_res_quantiles_famdistribution.tiff"), dpi = 300, units = "in",width = 6, height = 6)
```

Correspondence Analysis. This plot is obtained with factorminer

```{r PCA}
# First we calculate Principal component analysis with all numeric variables from anAge
res.pca <- primates_traits %>%
  select_if(is.numeric) %>%
  select(-ordering,-residuals,-dif) %>%
  PCA(., graph = FALSE)
```

The most important (or contributing) variables can be highlighted on the correlation plot as follow:

```{r correspondence analysis}
fviz_pca_var(res.pca, col.var = "contrib", repel = TRUE,
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07")) + theme(panel.grid = element_blank())
```

```{r, eval=FALSE}
var_quanti_cor <- as.data.frame(res.pca$var$cor)
var_quanti_cor
# ver de tree coverage, si me interesa
#info_cluster_elbow <- fviz_nbclust(res.pca, hcut, method = "silhouette", print.summary = TRUE )
```


si se hiciera por un factor, como el que usaron ellos de agrupar cada trait en 5 categorias, podría adaptar este código:

```{r, eval=FALSE}
#grp <- as.factor(cluster)
# Color variables by groups
#fviz_pca_var(res.pca, col.var = grp, 
#             palette = c("#0073C2FF", "#EFC000FF", "#868686FF"), legend.title = "Cluster")
```

